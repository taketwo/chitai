<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chitai - Controller</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,400;0,600;1,400;1,600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/web/styles.css" />
    <script src="/web/debug.js"></script>
    <script src="/web/websocket.js"></script>
    <script src="/web/controller/controller.js"></script>
    <script defer src="/web/vendor/alpine.min.js"></script>
  </head>
  <body class="controller">
    <div class="container" x-data="controllerApp()">
      <div x-ref="status" class="status"></div>

      <!-- Session not started: just show start button -->
      <div class="session-start" x-show="!sessionActive">
        <button :disabled="!connected" @click="startSession">
          Start session
        </button>
      </div>

      <!-- Session active: show everything -->
      <div x-show="sessionActive">
        <!-- Current Item (always visible) -->
        <div class="item-panel controls" x-show="hasWords">
          <button
            class="back-btn"
            :disabled="!sessionActive || isCompleted"
            @click="advanceWord(-1)"
          >
            <svg class="icon">
              <use href="/web/icons.svg#arrow-uturn-left"></use>
            </svg>
          </button>
          <div
            x-ref="currentWord"
            class="current-word"
            :class="{ 'completed': isCompleted }"
            x-text="currentWord"
          ></div>
          <button
            class="advance-btn"
            :class="{ 'next-item': isNextItemMode }"
            :disabled="!sessionActive || (isCompleted && queue.length === 0)"
            @click="advance"
          >
            <svg class="icon">
              <use :href="'/web/icons.svg#' + advanceButtonIcon"></use>
            </svg>
          </button>
        </div>

        <!-- Queue View -->
        <div x-show="currentView === 'queue'">
          <div class="queue-items">
            <template x-for="item in queue" :key="item.session_item_id">
              <div class="item-panel queue-item">
                <div class="drag-handle">
                  <svg class="icon">
                    <use href="/web/icons.svg#pause"></use>
                  </svg>
                </div>
                <div class="queue-item-text" x-text="item.text"></div>
              </div>
            </template>

            <!-- Virtual input item -->
            <div class="item-panel queue-item input-item">
              <div class="drag-handle"></div>
              <div class="input-wrapper">
                <textarea
                  class="text-input"
                  x-ref="textInput"
                  rows="1"
                  x-model="textInput"
                  placeholder="Enter text..."
                  @keydown.enter.prevent="handleEnter"
                  @input.debounce.200ms="fetchSuggestions()"
                  @blur="suggestions = []"
                ></textarea>
                <div
                  class="autocomplete-suggestions"
                  :class="'autocomplete-' + autocompletePosition"
                  x-show="suggestions.length > 0"
                >
                  <template
                    x-for="suggestion in suggestions"
                    :key="suggestion.id"
                  >
                    <button
                      type="button"
                      class="autocomplete-suggestion"
                      @mousedown.prevent="selectSuggestion(suggestion.text)"
                      x-text="suggestion.text"
                    ></button>
                  </template>
                </div>
              </div>
              <button
                class="enqueue-btn"
                :disabled="!sessionActive || !textInput.trim()"
                @click="submitToQueue"
              >
                <svg class="icon">
                  <use href="/web/icons.svg#arrow-turn-right-up"></use>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Library View -->
        <div class="library-view" x-show="currentView === 'library'">
          <div class="library-panel">
            <input
              type="text"
              class="text-input library-search-input"
              x-model="librarySearch"
              placeholder="Search library..."
              @input.debounce.300ms="searchLibrary()"
            />

            <div class="library-filters">
              <button
                class="filter-pill filter-new"
                :class="{ 'active': libraryFilterNew }"
                @click="toggleLibraryFilter('libraryFilterNew')"
              >
                New
              </button>
              <button
                class="filter-pill filter-illustrated"
                :class="{ 'active': libraryFilterIllustrated }"
                @click="toggleLibraryFilter('libraryFilterIllustrated')"
              >
                Illustrated
              </button>
              <button
                class="filter-pill filter-starred"
                :class="{ 'active': libraryFilterStarred }"
                @click="toggleLibraryFilter('libraryFilterStarred')"
              >
                Starred
              </button>
              <button class="filter-clear" @click="clearLibraryFilters">
                Clear
              </button>
            </div>

            <div class="library-results">
              <template x-for="item in libraryResults" :key="item.id">
                <div
                  class="library-result-item"
                  @click="addFromLibrary(item, $event)"
                >
                  <span class="item-text" x-text="item.text"></span>
                  <span class="item-indicators">
                    <span
                      class="indicator-dot dot-new"
                      x-show="item.is_new"
                    ></span>
                    <span
                      class="indicator-dot dot-illustrated"
                      x-show="item.has_illustrations"
                    ></span>
                    <span
                      class="indicator-dot dot-starred"
                      x-show="item.is_starred"
                    ></span>
                  </span>
                </div>
              </template>

              <div
                class="library-empty-state"
                x-show="libraryResults.length === 0 && !hasLibraryFilters"
              >
                Search or filter to find items
              </div>

              <div
                class="library-empty-state"
                x-show="libraryResults.length === 0 && hasLibraryFilters"
              >
                No items found
              </div>
            </div>
          </div>
        </div>

        <nav class="bottom-nav">
          <button
            class="end-session-btn"
            :disabled="!connected"
            @click="endSession"
          >
            <svg class="icon">
              <use href="/web/icons.svg#arrow-left-start-on-rectangle"></use>
            </svg>
          </button>
          <div class="nav-views">
            <button
              class="nav-btn"
              :class="{ 'active': currentView === 'queue' }"
              @click="switchView('queue')"
            >
              <svg class="icon">
                <use href="/web/icons.svg#queue-list"></use>
              </svg>
              <span>Queue</span>
            </button>
            <button
              class="nav-btn"
              :class="{ 'active': currentView === 'library' }"
              @click="switchView('library')"
            >
              <svg class="icon">
                <use href="/web/icons.svg#magnifying-glass"></use>
              </svg>
              <span>Library</span>
            </button>
          </div>
        </nav>
      </div>
    </div>
  </body>
</html>
