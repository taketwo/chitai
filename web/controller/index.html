<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chitai - Controller</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,400;0,600;1,400;1,600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/web/styles.css" />
    <script src="/web/debug.js"></script>
    <script src="/web/websocket.js"></script>
    <script src="/web/controller/controller.js"></script>
    <script defer src="/web/vendor/alpine.min.js"></script>
  </head>
  <body class="controller">
    <div class="container" x-data="controllerApp()">
      <div x-ref="status" class="status"></div>

      <!-- Session not started: just show start button -->
      <div class="session-start" x-show="!sessionActive">
        <button :disabled="!connected" @click="startSession">
          Start session
        </button>
      </div>

      <!-- Session active: show everything -->
      <div x-show="sessionActive">
        <div class="item-panel controls" x-show="hasWords">
          <button
            class="back-btn"
            :disabled="!sessionActive || isCompleted"
            @click="advanceWord(-1)"
          >
            <svg class="icon">
              <use href="/web/icons.svg#arrow-uturn-left"></use>
            </svg>
          </button>
          <div
            x-ref="currentWord"
            class="current-word"
            :class="{ 'completed': isCompleted }"
            x-text="currentWord"
          ></div>
          <button
            class="advance-btn"
            :class="{ 'next-item': isNextItemMode }"
            :disabled="!sessionActive || (isCompleted && queue.length === 0)"
            @click="advance"
          >
            <svg class="icon">
              <use :href="'/web/icons.svg#' + advanceButtonIcon"></use>
            </svg>
          </button>
        </div>

        <div class="queue-items">
          <template x-for="item in queue" :key="item.session_item_id">
            <div class="item-panel queue-item">
              <div class="drag-handle">
                <svg class="icon">
                  <use href="/web/icons.svg#pause"></use>
                </svg>
              </div>
              <div class="queue-item-text" x-text="item.text"></div>
            </div>
          </template>

          <!-- Virtual input item -->
          <div class="item-panel queue-item input-item">
            <div class="drag-handle"></div>
            <div class="input-wrapper">
              <textarea
                rows="1"
                x-model="textInput"
                placeholder="Enter text..."
                @keydown.enter.prevent="handleEnter"
                @input.debounce.200ms="fetchSuggestions()"
                @blur="suggestions = []"
              ></textarea>
              <div
                class="autocomplete-suggestions"
                x-show="suggestions.length > 0"
              >
                <template
                  x-for="suggestion in suggestions"
                  :key="suggestion.id"
                >
                  <button
                    type="button"
                    class="autocomplete-suggestion"
                    @mousedown.prevent="selectSuggestion(suggestion.text)"
                    x-text="suggestion.text"
                  ></button>
                </template>
              </div>
            </div>
            <button
              class="enqueue-btn"
              :disabled="!sessionActive || !textInput.trim()"
              @click="submitToQueue"
            >
              <svg class="icon">
                <use href="/web/icons.svg#arrow-turn-right-up"></use>
              </svg>
            </button>
          </div>
        </div>

        <div class="end-session-panel">
          <button
            class="end-session-btn"
            :disabled="!connected"
            @click="endSession"
          >
            <svg class="icon">
              <use href="/web/icons.svg#arrow-left-start-on-rectangle"></use>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
